<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Form Pendaftaran Lomba</title>
    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- DataTables -->
    <link
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <!-- AOS -->
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="bg-light">
    <div class="container-fluid" style="height: 100vh">
      <div class="row" style="height: 100%">
        <!-- Form Section -->
        <div
          class="col-md-3 p-3"
          data-aos="fade-right"
          style="display: flex; flex-direction: column; height: 100%"
        >
          <div
            class="card shadow"
            style="flex: 1; display: flex; flex-direction: column"
          >
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Form Pendaftaran Lomba</h5>
            </div>
            <div class="card-body" style="overflow-y: auto">
              <form id="lombaForm">
                <div class="mb-3">
                  <label for="nama" class="form-label">Nama Peserta</label>
                  <input type="text" id="nama" class="form-control" required />
                </div>

                <div class="mb-3">
                  <label for="usia" class="form-label">Kategori Usia</label>
                  <select id="usia" class="form-select" required>
                    <option value="">-- Pilih Usia --</option>
                    <option>Anak-anak</option>
                    <option>Remaja</option>
                    <option>Dewasa</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="lomba" class="form-label">Pilih Lomba</label>
                  <select id="lomba" class="form-select" required>
                    <option value="">-- Pilih Lomba --</option>
                    <option>Pindahin Bendera</option>
                    <option>Makan Kerupuk</option>
                    <option>Voli Balon</option>
                    <option>Balap Karung pakai Helm</option>
                    <option>Kelereng</option>
                    <option>Joget Bangku</option>
                    <option>Estafet Tiup</option>
                    <option>Tarik Tambang</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label for="juara" class="form-label">Juara</label>
                  <select id="juara" class="form-select" required>
                    <option value="">-- Pilih Juara --</option>
                    <option>Belum Dilombakan</option>
                    <option>Juara 1</option>
                    <option>Juara 2</option>
                    <option>Juara 3</option>
                  </select>
                </div>

                <input type="hidden" id="editIndex" />
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-success">Simpan</button>
                  <button
                    type="button"
                    id="exportExcel"
                    class="btn btn-warning"
                  >
                    Export ke Excel
                  </button>
                  <button
                    type="button"
                    id="exportTxt"
                    class="btn btn-secondary"
                  >
                    Export ke TXT
                  </button>
                  <button type="button" id="deleteAll" class="btn btn-danger">
                    Hapus Semua Data
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Table Section -->
        <div
          class="col-md-9 p-3"
          data-aos="fade-left"
          style="display: flex; flex-direction: column; height: 100%"
        >
          <div
            class="card shadow"
            style="flex: 1; display: flex; flex-direction: column"
          >
            <div class="card-header bg-dark text-white">
              <h5 class="mb-0">Data Pendaftaran</h5>
            </div>
            <div class="card-body" style="flex: 1; overflow-y: auto">
              <table
                id="lombaTable"
                class="table table-striped table-bordered w-100"
              >
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>Nama Peserta</th>
                    <th>Kategori Usia</th>
                    <th>Lomba</th>
                    <th>Juara</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Script -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    <script>
      AOS.init();

      let table;
      let dataLomba = [];
      let currentId = 1;

      // Simpan ke localStorage
      function saveToLocalStorage() {
        localStorage.setItem("dataLomba", JSON.stringify(dataLomba));
        localStorage.setItem("currentId", currentId);
      }

      // Load dari localStorage
      function loadFromLocalStorage() {
        const storedData = localStorage.getItem("dataLomba");
        const storedId = localStorage.getItem("currentId");
        if (storedData) {
          dataLomba = JSON.parse(storedData);
        }
        if (storedId) {
          currentId = parseInt(storedId);
        }
      }

      $(document).ready(function () {
        table = $("#lombaTable").DataTable();

        // Load data
        loadFromLocalStorage();
        dataLomba.forEach((row, index) => {
          table.row
            .add([
              row.id,
              row.nama,
              row.usia,
              row.lomba,
              row.juara,
              aksiButton(index),
            ])
            .draw();
        });

        // Submit Form
        $("#lombaForm").on("submit", function (e) {
          e.preventDefault();
          const nama = $("#nama").val();
          const usia = $("#usia").val();
          const lomba = $("#lomba").val();
          const juara = $("#juara").val();
          const editIndex = $("#editIndex").val();

          if (editIndex) {
            dataLomba[editIndex] = {
              id: dataLomba[editIndex].id,
              nama,
              usia,
              lomba,
              juara,
            };
            table
              .row(editIndex)
              .data([
                dataLomba[editIndex].id,
                nama,
                usia,
                lomba,
                juara,
                aksiButton(editIndex),
              ])
              .draw();
            Swal.fire("Berhasil!", "Data berhasil diupdate!", "success");
          } else {
            const id = currentId++;
            dataLomba.push({ id, nama, usia, lomba, juara });
            table.row
              .add([
                id,
                nama,
                usia,
                lomba,
                juara,
                aksiButton(dataLomba.length - 1),
              ])
              .draw();
            Swal.fire("Berhasil!", "Data berhasil ditambahkan!", "success");
          }

          saveToLocalStorage();
          $("#lombaForm")[0].reset();
          $("#editIndex").val("");
        });

        // Export
        $("#exportExcel").on("click", exportToExcel);
        $("#exportTxt").on("click", exportToTxt);
      });

      function aksiButton(index) {
        return `
    <button class="btn btn-sm btn-primary me-1" onclick="editData(${index})">Edit</button>
    <button class="btn btn-sm btn-danger" onclick="hapusData(${index})">Hapus</button>
  `;
      }

      function editData(index) {
        const d = dataLomba[index];
        $("#nama").val(d.nama);
        $("#usia").val(d.usia);
        $("#lomba").val(d.lomba);
        $("#juara").val(d.juara);
        $("#editIndex").val(index);
      }

      function hapusData(index) {
        Swal.fire({
          title: "Hapus Data?",
          text: "Data akan dihapus permanen!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Ya, hapus!",
        }).then((result) => {
          if (result.isConfirmed) {
            dataLomba.splice(index, 1);
            table.clear().draw();
            dataLomba.forEach((row, i) => {
              table.row
                .add([
                  row.id,
                  row.nama,
                  row.usia,
                  row.lomba,
                  row.juara,
                  aksiButton(i),
                ])
                .draw();
            });
            saveToLocalStorage();
            Swal.fire("Terhapus!", "Data berhasil dihapus.", "success");
          }
        });
      }

      function exportToExcel() {
        let csv = "ID,Nama Peserta,Kategori Usia,Lomba,Juara\n";
        dataLomba.forEach((row) => {
          csv += `${row.id},${row.nama},${row.usia},${row.lomba},${row.juara}\n`;
        });
        downloadFile(csv, "lomba_data.csv", "text/csv");
      }

      function exportToTxt() {
        let txt = "";
        dataLomba.forEach((row) => {
          txt += `ID: ${row.id} | Nama: ${row.nama} | Usia: ${row.usia} | Lomba: ${row.lomba} | Juara: ${row.juara}\n`;
        });
        downloadFile(txt, "lomba_data.txt", "text/plain");
      }

      function downloadFile(content, fileName, mimeType) {
        const a = document.createElement("a");
        const blob = new Blob([content], { type: mimeType });
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
      }

      // Hapus Semua Data
      $("#deleteAll").on("click", function () {
        Swal.fire({
          title: "Hapus Semua Data?",
          text: "Semua data akan dihapus permanen!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#d33",
          cancelButtonColor: "#6c757d",
          confirmButtonText: "Ya, hapus semua!",
        }).then((result) => {
          if (result.isConfirmed) {
            dataLomba = [];
            currentId = 1;
            table.clear().draw();
            saveToLocalStorage();
            Swal.fire("Terhapus!", "Semua data berhasil dihapus.", "success");
          }
        });
      });
    </script>
  </body>
</html>
