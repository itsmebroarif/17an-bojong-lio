<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Notion-Style Pendaftaran 17an</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- DataTables -->
    <link
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <!-- AOS -->
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
      :root {
        --bg: #f5f6fa;
        --surface: #ffffff;
        --surface-2: #fafbfc;
        --border: #e3e6ee;
        --muted: #6b7280;
        --text: #0f172a;
        --primary: #2f80ed;
        --success: #22c55e;
        --warning: #f59e0b;
        --danger: #ef4444;
        --radius-lg: 16px;
        --radius-md: 12px;
        --radius-sm: 8px;
        --shadow: 0 10px 30px rgba(2, 6, 23, 0.06);
        --shadow-sm: 0 6px 18px rgba(2, 6, 23, 0.05);
      }

      * {
        box-sizing: border-box;
      }
      body {
        background: var(--bg);
        color: var(--text);
        font-family: "Inter", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        letter-spacing: 0.1px;
      }

      /* MacOS Title Bar */
      .mac-window {
        max-width: 1200px;
        margin: 32px auto;
        background: var(--surface);
        border-radius: calc(var(--radius-lg) + 4px);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        overflow: hidden;
      }
      .mac-titlebar {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        background: linear-gradient(180deg, #eef1f6, #e6e9f0);
        border-bottom: 1px solid var(--border);
      }
      .traffic {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.08);
      }
      .dot.red {
        background: #ff5f57;
      }
      .dot.yellow {
        background: #ffbd2e;
      }
      .dot.green {
        background: #28c840;
      }
      .app-title {
        font-weight: 600;
        color: #111827;
        margin-left: 6px;
      }

      /* Shell */
      .shell {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 0;
        min-height: 70vh;
      }

      /* Sidebar / Block Panel */
      .sidebar {
        background: var(--surface-2);
        border-right: 1px solid var(--border);
        padding: 18px;
      }
      .sidebar .block {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
      }
      .block-header {
        padding: 12px 16px;
        background: var(--surface-2);
        border-bottom: 1px solid var(--border);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .block-body {
        padding: 16px;
      }
      .form-label {
        font-weight: 600;
        color: #111827;
      }
      .form-control,
      .form-select {
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
      }
      .btn {
        border-radius: 12px;
        transition: transform 0.15s ease, box-shadow 0.2s ease;
      }
      .btn:focus {
        box-shadow: 0 0 0 0.25rem rgba(47, 128, 237, 0.15);
      }
      .btn:hover {
        transform: translateY(-1px);
      }

      /* Main (Table) */
      .main {
        padding: 18px;
        background: var(--surface);
      }
      .panel {
        height: 100%;
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        overflow: hidden;
      }
      .panel-header {
        padding: 14px 16px;
        background: var(--surface-2);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }
      .searchbox {
        display: flex;
        align-items: center;
        gap: 8px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 6px 10px;
        min-width: 240px;
      }
      .searchbox input {
        border: none;
        outline: none;
        width: 100%;
      }
      .panel-body {
        padding: 16px;
      }

      /* DataTable prettify */
      table.dataTable thead th {
        background: #f1f2f6;
        border-bottom: none !important;
      }
      table.dataTable.no-footer {
        border-bottom: 1px solid var(--border);
      }
      table.dataTable tbody tr {
        transition: background 0.15s ease;
      }
      table.dataTable tbody tr:hover {
        background: #fafafa;
      }
      .table {
        border-radius: 14px;
        overflow: hidden;
      }

      /* Aksi buttons */
      .btn-ghost {
        background: #f5f6fa;
        border: 1px solid var(--border);
      }

      /* SweetAlert on top of modals */
      .swal2-container {
        z-index: 30000 !important;
      }

      /* Responsive */
      @media (max-width: 992px) {
        .shell {
          grid-template-columns: 1fr;
        }
        .sidebar {
          order: 2;
        }
        .main {
          order: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="mac-window" data-aos="fade-up">
      <div class="mac-titlebar">
        <div class="traffic">
          <span class="dot red"></span>
          <span class="dot yellow"></span>
          <span class="dot green"></span>
        </div>
        <div class="app-title">Halo, Arif Alexander!</div>
      </div>

      <div class="shell">
        <!-- Sidebar -->
        <aside class="sidebar" data-aos="fade-right">
          <div class="block">
            <div class="block-header">‚úèÔ∏è Form Pendaftaran</div>
            <div class="block-body">
              <form id="lombaForm" class="needs-validation" novalidate>
                <div class="mb-3">
                  <label class="form-label">Nama Peserta</label>
                  <input
                    type="text"
                    id="nama"
                    class="form-control"
                    placeholder="Tulis nama..."
                    required
                  />
                  <div class="invalid-feedback">Nama wajib diisi.</div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Kategori Usia</label>
                  <select id="usia" class="form-select" required>
                    <option value="">-- Pilih Usia --</option>
                    <option>Anak-anak</option>
                    <option>Remaja</option>
                    <option>Dewasa</option>
                  </select>
                  <div class="invalid-feedback">Pilih kategori usia.</div>
                </div>
                <div class="mb-3">
                  <label class="form-label">Lomba</label>
                  <select id="lomba" class="form-select" required>
                    <option value="">-- Pilih Lomba --</option>
                    <option>Pindahin Bendera</option>
                    <option>Makan Kerupuk</option>
                    <option>Voli Balon</option>
                    <option>Balap Karung pakai Helm</option>
                    <option>Kelereng</option>
                    <option>Joget Bangku</option>
                    <option>Estafet Tiup</option>
                    <option>Cantol Kawat Cukurukuk</option>
                    <option>Tarik Tambang</option>
                  </select>
                  <div class="invalid-feedback">Pilih jenis lomba.</div>
                </div>
                <div class="mb-4">
                  <label class="form-label">Juara</label>
                  <select id="juara" class="form-select" required>
                    <option value="">-- Pilih Juara --</option>
                    <option>Belum Dilombakan</option>
                    <option>Belum Juara</option>
                    <option>Grand Final Juara 1</option>
                    <option>Grand Final Juara 2</option>
                    <option>Grand Final Juara 3</option>
                    <option>Juara 1</option>
                    <option>Juara 2</option>
                    <option>Juara 3</option>
                  </select>
                  <div class="invalid-feedback">Pilih status juara.</div>
                </div>
                <div class="d-grid gap-2">
                  <button type="submit" class="btn btn-success">
                    ‚úÖ Simpan
                  </button>
                  <button
                    type="button"
                    id="exportExcel"
                    class="btn btn-warning"
                  >
                    üìë Export Excel (CSV)
                  </button>
                  <button type="button" id="exportPDF" class="btn btn-danger">
                    üìÑ Export PDF
                  </button>
                  <button
                    type="button"
                    id="deleteAll"
                    class="btn btn-secondary"
                  >
                    üóëÔ∏è Hapus Semua
                  </button>
                </div>
              </form>
            </div>
          </div>
        </aside>

        <!-- Main -->
        <main class="main" data-aos="fade-left">
          <div class="panel">
            <div class="panel-header">
              <div class="fw-semibold">üìã Data Pendaftaran</div>
              <div class="d-flex align-items-center gap-2">
                <div class="searchbox">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path
                      d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z"
                      stroke="#6b7280"
                      stroke-width="1.8"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    />
                  </svg>
                  <input
                    id="tableSearch"
                    type="search"
                    placeholder="Cari data..."
                  />
                </div>
                <button id="resetFilter" class="btn btn-ghost">Reset</button>
              </div>
            </div>
            <div class="panel-body">
              <table
                id="lombaTable"
                class="table table-hover table-bordered w-100"
              >
                <thead>
                  <tr>
                    <th style="width: 70px">ID</th>
                    <th>Nama</th>
                    <th>Kategori Usia</th>
                    <th>Lomba</th>
                    <th>Juara</th>
                    <th style="width: 150px">Aksi</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Modal Edit -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 border-0 shadow">
          <div class="modal-header bg-light border-0">
            <h5 class="modal-title">‚úèÔ∏è Edit Data Peserta</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Tutup"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editForm" class="needs-validation" novalidate>
              <input type="hidden" id="editIndex" />
              <div class="mb-3">
                <label class="form-label">Nama Peserta</label>
                <input
                  type="text"
                  id="editNama"
                  class="form-control"
                  required
                />
                <div class="invalid-feedback">Nama wajib diisi.</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Kategori Usia</label>
                <select id="editUsia" class="form-select" required>
                  <option>Anak-anak</option>
                  <option>Remaja</option>
                  <option>Dewasa</option>
                </select>
                <div class="invalid-feedback">Pilih kategori usia.</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Lomba</label>
                <select id="editLomba" class="form-select" required>
                  <option>Pindahin Bendera</option>
                  <option>Makan Kerupuk</option>
                  <option>Voli Balon</option>
                  <option>Balap Karung pakai Helm</option>
                  <option>Kelereng</option>
                  <option>Joget Bangku</option>
                  <option>Estafet Tiup</option>
                  <option>Cantol Kawat Cukurukuk</option>
                  <option>Tarik Tambang</option>
                </select>
                <div class="invalid-feedback">Pilih lomba.</div>
              </div>
              <div class="mb-3">
                <label class="form-label">Juara</label>
                <select id="editJuara" class="form-select" required>
                  <option>Belum Dilombakan</option>
                  <option>Belum Juara</option>
                  <option>Juara 1</option>
                  <option>Juara 2</option>
                  <option>Juara 3</option>
                </select>
                <div class="invalid-feedback">Pilih status juara.</div>
              </div>
              <div class="d-grid">
                <button type="submit" class="btn btn-success">üíæ Update</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Libs -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>

    <script>
      AOS.init();

      let table;
      let dataLomba = [];
      let currentId = 1;

      // ----- Local Storage -----
      function saveToLocalStorage() {
        localStorage.setItem("dataLomba", JSON.stringify(dataLomba));
        localStorage.setItem("currentId", String(currentId));
      }
      function loadFromLocalStorage() {
        try {
          const storedData = JSON.parse(
            localStorage.getItem("dataLomba") || "[]"
          );
          const storedId = parseInt(localStorage.getItem("currentId") || "1");
          if (Array.isArray(storedData)) dataLomba = storedData;
          if (!Number.isNaN(storedId)) currentId = storedId;
        } catch (e) {
          dataLomba = [];
          currentId = 1;
        }
      }

      // ----- DataTable & Render -----
      function aksiButton(index) {
        return `
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-primary" onclick="editData(${index})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="hapusData(${index})">Hapus</button>
        </div>
      `;
      }

      function refreshTable() {
        table.clear();
        dataLomba.forEach((row, i) => {
          table.row.add([
            row.id,
            row.nama,
            row.usia,
            row.lomba,
            row.juara,
            aksiButton(i),
          ]);
        });
        table.draw(false);
        saveToLocalStorage();
      }

      // CSV util (safe with quotes)
      function toCSV(rows) {
        const esc = (v) => `"${String(v).replace(/"/g, '""')}"`;
        const header = ["ID", "Nama", "Usia", "Lomba", "Juara"]
          .map(esc)
          .join(",");
        const body = rows
          .map((r) =>
            [r.id, r.nama, r.usia, r.lomba, r.juara].map(esc).join(",")
          )
          .join("\n");
        return header + "\n" + body;
      }
      function downloadFile(content, fileName, mimeType) {
        const a = document.createElement("a");
        const blob = new Blob([content], { type: mimeType });
        a.href = URL.createObjectURL(blob);
        a.download = fileName;
        a.click();
        URL.revokeObjectURL(a.href);
      }

      // ----- Validation (Bootstrap) -----
      (function () {
        const forms = document.querySelectorAll(".needs-validation");
        Array.from(forms).forEach((form) => {
          form.addEventListener(
            "submit",
            (event) => {
              if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
              }
              form.classList.add("was-validated");
            },
            false
          );
        });
      })();

      // ----- Init -----
      $(document).ready(function () {
        table = $("#lombaTable").DataTable({
          order: [
            [3, "asc"],
            [2, "asc"],
          ],
          pageLength: 10,
          lengthMenu: [5, 10, 25, 50, 100],
        });

        // search box custom
        $("#tableSearch").on("keyup", function () {
          table.search(this.value).draw();
        });
        $("#resetFilter").on("click", function () {
          $("#tableSearch").val("");
          table.search("").draw();
        });

        loadFromLocalStorage();
        refreshTable();

        // Tambah data
        $("#lombaForm").on("submit", function (e) {
          e.preventDefault();
          if (!this.checkValidity()) {
            return;
          }

          const nama = $("#nama").val().trim();
          const usia = $("#usia").val();
          const lomba = $("#lomba").val();
          const juara = $("#juara").val();
          const id = currentId++;

          dataLomba.push({ id, nama, usia, lomba, juara });
          refreshTable();
          this.reset();
          this.classList.remove("was-validated");

          Swal.fire({
            icon: "success",
            title: "Berhasil!",
            text: "Data berhasil ditambahkan!",
            confirmButtonText: "OK",
          });
        });

        // Export CSV (Excel)
        $("#exportExcel").on("click", function () {
          const csv = toCSV(dataLomba);
          downloadFile(csv, "lomba_data.csv", "text/csv;charset=utf-8;");
          Swal.fire({
            icon: "success",
            title: "Sukses!",
            text: "Data berhasil di-export ke CSV (bisa dibuka dengan Excel).",
            confirmButtonText: "OK",
          });
        });

        // Export PDF
        $("#exportPDF").on("click", function () {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });
          const title = "Data Pendaftaran Lomba 17an";
          doc.setFontSize(14);
          doc.text(title, 40, 40);
          doc.autoTable({
            startY: 60,
            head: [["ID", "Nama", "Usia", "Lomba", "Juara"]],
            body: dataLomba.map((r) => [
              r.id,
              r.nama,
              r.usia,
              r.lomba,
              r.juara,
            ]),
            styles: { fontSize: 10, cellPadding: 6 },
            headStyles: { fillColor: [241, 242, 246], textColor: 15 },
          });
          doc.save("lomba_data.pdf");

          Swal.fire({
            icon: "success",
            title: "Sukses!",
            text: "Data berhasil di-export ke PDF.",
            confirmButtonText: "OK",
          });
        });

        // Hapus semua
        $("#deleteAll").on("click", function () {
          Swal.fire({
            title: "Hapus Semua?",
            text: "Semua data akan dihapus permanen!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Ya, hapus!",
            cancelButtonText: "Batal",
          }).then((res) => {
            if (res.isConfirmed) {
              dataLomba = [];
              currentId = 1;
              refreshTable();
              Swal.fire({
                icon: "success",
                title: "Terhapus!",
                text: "Semua data dihapus.",
                confirmButtonText: "OK",
              });
            }
          });
        });
      });

      // ----- Edit / Hapus -----
      function editData(index) {
        const d = dataLomba[index];
        if (!d) return;
        $("#editIndex").val(index);
        $("#editNama").val(d.nama);
        $("#editUsia").val(d.usia);
        $("#editLomba").val(d.lomba);
        $("#editJuara").val(d.juara);
        new bootstrap.Modal(document.getElementById("editModal")).show();
      }

      $("#editForm").on("submit", function (e) {
        e.preventDefault();
        if (!this.checkValidity()) {
          return;
        }

        const idx = parseInt($("#editIndex").val());
        if (Number.isInteger(idx) && dataLomba[idx]) {
          dataLomba[idx] = {
            id: dataLomba[idx].id,
            nama: $("#editNama").val().trim(),
            usia: $("#editUsia").val(),
            lomba: $("#editLomba").val(),
            juara: $("#editJuara").val(),
          };
          refreshTable();

          const editModalEl = document.getElementById("editModal");
          const modal = bootstrap.Modal.getInstance(editModalEl);
          modal.hide();

          // Tampilkan alert setelah modal benar-benar tertutup
          const onHidden = () => {
            editModalEl.removeEventListener("hidden.bs.modal", onHidden);
            Swal.fire({
              icon: "success",
              title: "Berhasil!",
              text: "Data berhasil diperbarui!",
              confirmButtonText: "OK",
            });
          };
          editModalEl.addEventListener("hidden.bs.modal", onHidden);
        }
      });

      function hapusData(index) {
        Swal.fire({
          title: "Hapus Data?",
          text: "Data akan dihapus permanen!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Ya, hapus!",
          cancelButtonText: "Batal",
        }).then((res) => {
          if (res.isConfirmed) {
            dataLomba.splice(index, 1);
            refreshTable();
            Swal.fire({
              icon: "success",
              title: "Terhapus!",
              text: "Data berhasil dihapus.",
              confirmButtonText: "OK",
            });
          }
        });
      }
      // Expose for inline onclick
      window.editData = editData;
      window.hapusData = hapusData;
    </script>
  </body>
</html>
